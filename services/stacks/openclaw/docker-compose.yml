# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json

# Stack: openclaw
# Description: OpenClaw AI assistant with Docker-in-Docker and ProtonMail Bridge

services:
  openclaw:
    container_name: openclaw
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - dind
      - dockerproxy
      - protonmail-bridge
    volumes:
      # OpenClaw state
      - /mnt/user/appdata/openclaw/.openclaw:/home/openclaw/.openclaw
      - /mnt/user/repos:/home/openclaw/.openclaw/repos
      - /mnt/user/appdata/openclaw/certs:/certs/client:ro
      # Unraid shares
      - /mnt/user/appdata:/mnt/user/appdata:ro
      - /mnt/user/appdata-dev:/mnt/user/appdata-dev
      - /mnt/user/data:/mnt/user/data:ro
      - /mnt/user/db:/mnt/user/db
      - /mnt/user/docs:/mnt/user/docs
      - /mnt/user/domains/templates:/mnt/user/domains/templates
      - /mnt/user/immich-data:/mnt/user/immich-data
      - /mnt/user/isos:/mnt/user/isos
      - /mnt/user/photos:/mnt/user/photos
      - /mnt/user/photos_manual:/mnt/user/photos_manual
      - /mnt/user/repos:/mnt/user/repos
      # Timezone
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - proxy
      - net
    environment:
      TZ: "America/Chicago"
      # Docker via socket proxy (no direct socket access)
      DOCKER_HOST: "tcp://dockerproxy:2375"
      # API Keys
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"
      OPENCLAW_GATEWAY_TOKEN: "${OPENCLAW_GATEWAY_TOKEN}"
      # ProtonMail Bridge (IMAP/SMTP)
      IMAP_HOST: "protonmail-bridge"
      IMAP_PORT: "143"
      SMTP_HOST: "protonmail-bridge"
      SMTP_PORT: "25"
      PROTONMAIL_USER: "${PROTONMAIL_USER}"
      PROTONMAIL_PASS: "${PROTONMAIL_PASS}"
    labels:
      traefik.enable: true
      traefik.http.routers.openclaw.rule: "Host(`claw.trkm.io`)"
      traefik.http.services.openclaw.loadBalancer.server.port: 18789

  dockerproxy:
    container_name: openclaw-dockerproxy
    image: tecnativa/docker-socket-proxy:0.4.2
    restart: unless-stopped
    privileged: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - net
    environment:
      # Read-only by default. Explicitly allow what we need.
      LOG_LEVEL: info
      # Info (read-only)
      CONTAINERS: 1
      IMAGES: 1
      NETWORKS: 1
      VOLUMES: 1
      INFO: 1
      VERSION: 1
      EVENTS: 1
      # Management (write)
      POST: 1              # Allow start/stop/restart
      ALLOW_START: 1
      ALLOW_STOP: 1
      ALLOW_RESTARTS: 1
      # Deny dangerous operations
      AUTH: 0
      SECRETS: 0
      SWARM: 0
      BUILD: 0
      COMMIT: 0
      CONFIGS: 0
      DISTRIBUTION: 0
      EXEC: 0
      GRPC: 0
      NODES: 0
      PLUGINS: 0
      SERVICES: 0
      SESSION: 0
      SYSTEM: 0
      TASKS: 0

  dind:
    container_name: openclaw-dind
    image: docker:dind
    restart: unless-stopped
    privileged: true
    volumes:
      - /mnt/user/appdata/openclaw/dind:/var/lib/docker
      - /mnt/user/appdata/openclaw/certs:/certs
      - /mnt/user/appdata-dev:/mnt/appdata
    networks:
      - net
    environment:
      DOCKER_TLS_CERTDIR: "/certs"

  protonmail-bridge:
    container_name: openclaw-protonmail
    image: shenxn/protonmail-bridge:latest
    restart: unless-stopped
    volumes:
      - /mnt/user/appdata/openclaw/protonmail:/root
    networks:
      - net

networks:
  proxy:
    external: true
  net:
