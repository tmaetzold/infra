---
# Docker role tasks
# Sets up Docker repository and installs Docker packages

- name: Gather facts if not already gathered
  ansible.builtin.setup:
  when: ansible_os_family is not defined

- name: Remove conflicting Docker packages
  ansible.builtin.include_role:
    name: trkm.main.packages
  vars:
    remove_packages_apt: "{{ docker_remove_packages_apt }}"
    remove_packages_dnf: "{{ docker_remove_packages_dnf }}"
    update_cache: false
    update_packages: false

- name: Add Docker repository (Debian/Ubuntu)
  ansible.builtin.deb822_repository:
    name: docker
    types: deb
    uris: "https://download.docker.com/linux/{{ ansible_distribution | lower }}"
    suites: "{{ ansible_distribution_release }}"
    components: stable
    signed_by: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg"
    state: present
  when: ansible_os_family == "Debian"

- name: Add Docker repository (RHEL/CentOS)
  ansible.builtin.command:
    cmd: "dnf config-manager --add-repo https://download.docker.com/linux/{{ 'rhel' if ansible_distribution == 'RedHat' else 'centos' }}/docker-ce.repo"
    creates: /etc/yum.repos.d/docker-ce.repo
  when: ansible_os_family == "RedHat"

- name: Install Docker packages
  ansible.builtin.include_role:
    name: trkm.main.packages
  vars:
    packages_apt: "{{ docker_packages }}"
    packages_dnf: "{{ docker_packages }}"
    packages_pacman: "{{ docker_packages_pacman }}"
    update_cache: true
    update_packages: false

- name: Ensure Docker service is started and enabled
  ansible.builtin.systemd:
    name: docker
    state: "{{ docker_service_state }}"
    enabled: "{{ docker_service_enabled }}"
  when: docker_service_enabled | bool
